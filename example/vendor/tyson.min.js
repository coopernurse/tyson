// tyson.js
(function(a){var b={},c={},d={},e=0,f=function(a){b.trace&&console&&console.log&&console.log(a)},g=function(){return typeof a.require=="function"},h=function(a){return!!(a&&a.constructor&&a.call&&a.apply)},i=function(){return e+=1,e+"-tyson-id"},j=function(a){var b=d[a._tysonId];b?k(b):a._tysonId&&f("tyson: cleanBindingForElement no binding found for el: "+a+" el._tysonId="+a._tysonId)},k=function(a){var c,e,g;f("tyson: cleanBinding start id="+a.id);if(a.vm.childComponents)for(c in a.vm.childComponents)a.vm.childComponents.hasOwnProperty(c)&&(e=a.vm.childComponents[c],g=d[e._tysonId],g&&(a.vm.preUnbindChild&&a.vm.preUnbindChild({component:c,vm:g.vm,el:g.el}),f("tyson: cleaningChildBinding parent="+a.id+" child="+g.id),k(g),a.vm.postUnbindChild&&a.vm.postUnbindChild({component:c,vm:g.vm,el:g.el})));a.vm.preUnbind&&a.vm.preUnbind(),a.vm.boundToDOM=!1,b.ko.cleanNode(a.el),delete d[a.id],a.vm.postUnbind&&a.vm.postUnbind()},l=function(a,c){var d=b.component(a);if(d){c(d);return}b.loader(a,function(d){b.component(a,d),c(d)})};b.component=function(a,b){return b&&(c[a]=b),c[a]},b.start=function(c,d){b.rootEl=c.rootEl,b.loader=c.loader,b.router=c.router,b.trace=c.trace||!1,g()?require(["knockout","director"],function(a,c){b.ko=a,b.DirectorRouter=c,b.router.start(),d&&d()}):(b.ko=a.ko,b.DirectorRouter=a.Router,b.router.start(),d&&d())},b.bindComponent=function(a,c,e,g){if(!a)throw new Error("tyson.bindComponent: componentName is not defined!");if(!c)throw new Error("tyson.bindComponent: elToBindTo is not defined for componentName: "+a);f("tyson: bindComponent start: "+a),l(a,function(h){var k,l,m,n,o=i();if(!h.viewModel)throw new Error("component name="+a+" does not have a viewModel");if(!h.html)throw new Error("component name="+a+" does not have html");j(c),c.innerHTML=h.html,c._tysonId=o,m=h.viewModel.apply(h,e),n={id:o,vm:m,el:c},d[o]=n,b.ko.applyBindings(m,c),m.boundToDOM=!0,m.postBind&&m.postBind();if(m.childComponents){l=[];for(k in m.childComponents)m.childComponents.hasOwnProperty(k)&&(f("tyson: child: "+k+" el: "+m.childComponents[k]),b.bindComponent(k,m.childComponents[k],[],function(a){m.postBindChild&&m.postBindChild({component:k,vm:a.vm,el:a.el})}))}Object&&Object.keys&&JSON&&f("tyson: bindComponent  done: "+a+" id: "+o+" bindingsById.keys: "+JSON.stringify(Object.keys(d))),g&&g(n)})},b.director=function(a){var c=function(){var c={},d,e,f;e=function(a){return function(){var c,d=[];for(c=0;c<arguments.length;c+=1)arguments[c]===null||arguments[c]===undefined?d.push(arguments[c]):d.push(decodeURIComponent(arguments[c]));b.bindComponent(a,b.rootEl,d)}};for(d in a.routes)a.routes.hasOwnProperty(d)&&(h(a.routes[d])?c[d]=a.routes[d]:c[d]=e(a.routes[d]));f=b.DirectorRouter(c),a.options&&f.configure(a.options),f.init(a.root)};return{start:c}},g()?define("tyson",function(){return b}):a.$tyson=b})(window);