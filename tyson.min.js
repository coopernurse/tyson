// tyson.js
(function(e){var t={},n={},r={},i=0,s=function(e){t.trace&&console&&console.log&&console.log(e)},o=function(){return typeof e.require=="function"},u=function(e){return!!(e&&e.constructor&&e.call&&e.apply)},a=function(){return i+=1,i+"-tyson-id"},f=function(e){var n,i,o,u;s("tyson: cleanBinding start id="+e.id);if(e.vm.childComponents)for(n=0;n<e.vm.childComponents.length;n+=1)i=e.vm.childComponents[n],o=i.el,t.bound(o)&&(u=r[o._tysonId],e.vm.preUnbindChild&&e.vm.preUnbindChild({component:i,vm:u.vm,el:u.el}),s("tyson: cleaningChildBinding parent="+e.id+" child="+u.id),f(u),e.vm.postUnbindChild&&e.vm.postUnbindChild({component:i,vm:u.vm,el:u.el}));e.vm.preUnbind&&e.vm.preUnbind(),e.vm.boundToDOM=!1,t.ko.cleanNode(e.el),e.el.innerHTML="",delete e.el._tysonId,delete r[e.id],e.vm.postUnbind&&e.vm.postUnbind()},l=function(e,n){var r=t.component(e);r?n(r):t.loader(e,function(r){t.component(e,r),n(r)})};t.component=function(e,t){return t&&(n[e]=t),n[e]},t.start=function(n,r){t.rootEl=n.rootEl,t.loader=n.loader,t.router=n.router,t.trace=n.trace||!1,o()?require(["knockout","director"],function(e,n){t.ko=e,t.DirectorRouter=n,t.router.start(),r&&r()}):(t.ko=e.ko,t.DirectorRouter=e.Router,t.router.start(),r&&r())},t.bound=function(e){return e&&e._tysonId&&r[e._tysonId]},t.clean=function(e){if(e){var t=r[e._tysonId];t?f(t):e._tysonId&&s("tyson: clean no binding found for el: "+e+" el._tysonId="+e._tysonId)}},t.bind=function(e,n,i,o){if(!n)throw new Error("tyson.bind: componentName is not defined!");if(!e)throw new Error("tyson.bind: el is not defined! (componentName="+n+")");s("tyson: bind start: "+n),l(n,function(u){var f,l,c,h,p,d,v=a();if(!u.viewModel)throw new Error("component name="+n+" does not have a viewModel");if(!u.html)throw new Error("component name="+n+" does not have html");t.clean(e),e.innerHTML=u.html,e._tysonId=v,h=u.viewModel.apply(u,i),p={id:v,vm:h,el:e},r[v]=p,t.ko.applyBindings(h,e),h.boundToDOM=!0,h.postBind&&h.postBind();if(h.childComponents){c=[],d=function(e){h.postBindChild&&h.postBindChild({component:l.component,vm:e.vm,el:e.el})};for(f=0;f<h.childComponents.length;f+=1)l=h.childComponents[f],l.component&&(s("tyson: child: "+l.component+" el: "+l.el),t.bind(l.el,l.component,[],d))}Object&&Object.keys&&JSON&&s("tyson: bind  done: "+n+" id: "+v+" bindingsById.keys: "+JSON.stringify(Object.keys(r))),o&&o(p)})},t.director=function(e){var n=function(){var n={},r,i,s;i=function(e){return function(){var n,r=[];for(n=0;n<arguments.length;n+=1)arguments[n]===null||arguments[n]===undefined?r.push(arguments[n]):r.push(decodeURIComponent(arguments[n]));t.bind(t.rootEl,e,r)}};for(r in e.routes)e.routes.hasOwnProperty(r)&&(u(e.routes[r])?n[r]=e.routes[r]:n[r]=i(e.routes[r]));s=t.DirectorRouter(n),e.options&&s.configure(e.options),s.init(e.root)};return{start:n}},t.requirejsLoader=function(e,t){return function(n,r){var i=t+n;require([i],function(s){s.html?r(s):(i=t+n+".html",e(i,function(e){s.html=e,r(s)}))})}},t.scriptjsLoader=function(e,n){return function(r,i){var s=n+r+".js";$script(s,function(){var o=t.component(r);o.html?i(o):(s=n+r+".html",e(s,function(e){o.html=e,i(o)}))})}},o()?define("tyson",function(){return t}):e.$tyson=t})(window);